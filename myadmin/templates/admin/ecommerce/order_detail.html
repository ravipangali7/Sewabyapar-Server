{% extends 'admin/layouts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid p-0">
    <div class="mb-3">
        <h1 class="h3 d-inline align-middle">Order Details</h1>
        <a class="btn btn-primary ms-2" href="{% url 'myadmin:ecommerce:order_update' order.pk %}">
            <i class="align-middle" data-feather="edit"></i> Edit
        </a>
        <a class="btn btn-danger ms-2" href="{% url 'myadmin:ecommerce:order_delete' order.pk %}">
            <i class="align-middle" data-feather="trash-2"></i> Delete
        </a>
        <a class="btn btn-secondary ms-2" href="{% url 'myadmin:ecommerce:order_list' %}">
            <i class="align-middle" data-feather="arrow-left"></i> Back to List
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-3">
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h6 class="text-muted mb-2">Total Amount</h6>
                            <h4 class="mb-0">₹{{ order.total_amount|floatformat:2 }}</h4>
                        </div>
                        <div class="col-auto">
                            <div class="stat text-primary">
                                <i class="align-middle" data-feather="dollar-sign"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h6 class="text-muted mb-2">Status</h6>
                            <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'pending' %}warning{% elif order.status == 'cancelled' %}danger{% else %}info{% endif %} fs-6">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                        <div class="col-auto">
                            <div class="stat text-primary">
                                <i class="align-middle" data-feather="{% if order.status == 'delivered' %}check-circle{% elif order.status == 'pending' %}clock{% elif order.status == 'cancelled' %}x-circle{% else %}info{% endif %}"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h6 class="text-muted mb-2">Items</h6>
                            <h4 class="mb-0">{{ order.items.count }}</h4>
                        </div>
                        <div class="col-auto">
                            <div class="stat text-primary">
                                <i class="align-middle" data-feather="package"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h6 class="text-muted mb-2">Order Date</h6>
                            <div class="fs-6">{{ order.created_at|date:"M d, Y" }}</div>
                        </div>
                        <div class="col-auto">
                            <div class="stat text-primary">
                                <i class="align-middle" data-feather="calendar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h6 class="text-muted mb-2">Payment Status</h6>
                            <span class="badge bg-{% if order.payment_status == 'success' %}success{% elif order.payment_status == 'failed' %}danger{% elif order.payment_status == 'cancelled' %}secondary{% else %}warning{% endif %} fs-6">
                                {{ order.get_payment_status_display }}
                            </span>
                        </div>
                        <div class="col-auto">
                            <div class="stat text-primary">
                                <i class="align-middle" data-feather="{% if order.payment_status == 'success' %}check-circle{% elif order.payment_status == 'failed' %}x-circle{% else %}clock{% endif %}"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Order Information -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-feather="shopping-cart"></i> Order Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="hash" style="width: 16px; height: 16px;"></i> Order Number:</strong></div>
                        <div class="col-sm-8">
                            <span class="badge bg-info fs-6">{{ order.order_number }}</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="user" style="width: 16px; height: 16px;"></i> Customer:</strong></div>
                        <div class="col-sm-8">
                            <a href="{% url 'myadmin:core:user_detail' order.user.pk %}" class="text-decoration-none">{{ order.user.name }}</a>
                        </div>
                    </div>
                    {% if order.merchant %}
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="store" style="width: 16px; height: 16px;"></i> Merchant:</strong></div>
                        <div class="col-sm-8">
                            <a href="{% url 'myadmin:ecommerce:store_detail' order.merchant.pk %}" class="text-decoration-none">{{ order.merchant.name }}</a>
                        </div>
                    </div>
                    {% endif %}
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="phone" style="width: 16px; height: 16px;"></i> Phone:</strong></div>
                        <div class="col-sm-8">{{ order.phone }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="mail" style="width: 16px; height: 16px;"></i> Email:</strong></div>
                        <div class="col-sm-8">{{ order.email }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="tag" style="width: 16px; height: 16px;"></i> Status:</strong></div>
                        <div class="col-sm-8">
                            <span class="badge bg-{% if order.status == 'delivered' %}success{% elif order.status == 'pending' %}warning{% elif order.status == 'cancelled' %}danger{% else %}info{% endif %} fs-6">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="dollar-sign" style="width: 16px; height: 16px;"></i> Subtotal:</strong></div>
                        <div class="col-sm-8">₹{{ order.subtotal|floatformat:2 }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="truck" style="width: 16px; height: 16px;"></i> Shipping Cost:</strong></div>
                        <div class="col-sm-8">₹{{ order.shipping_cost|floatformat:2 }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="dollar-sign" style="width: 16px; height: 16px;"></i> Total Amount:</strong></div>
                        <div class="col-sm-8">
                            <h5 class="mb-0">₹{{ order.total_amount|floatformat:2 }}</h5>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="credit-card" style="width: 16px; height: 16px;"></i> Payment Method:</strong></div>
                        <div class="col-sm-8">
                            <span class="badge bg-{% if order.payment_method == 'online' %}info{% else %}secondary{% endif %} fs-6">
                                {{ order.get_payment_method_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="check-circle" style="width: 16px; height: 16px;"></i> Payment Status:</strong></div>
                        <div class="col-sm-8">
                            <span class="badge bg-{% if order.payment_status == 'success' %}success{% elif order.payment_status == 'failed' %}danger{% elif order.payment_status == 'cancelled' %}secondary{% else %}warning{% endif %} fs-6">
                                {{ order.get_payment_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="calendar" style="width: 16px; height: 16px;"></i> Created:</strong></div>
                        <div class="col-sm-8">
                            <i class="align-middle" data-feather="clock" style="width: 14px; height: 14px;"></i>
                            {{ order.created_at|date:"F d, Y" }}<br>
                            <small class="text-muted">{{ order.created_at|date:"g:i A" }}</small>
                        </div>
                    </div>
                    {% if order.merchant_ready_date %}
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="check-circle" style="width: 16px; height: 16px;"></i> Merchant Ready:</strong></div>
                        <div class="col-sm-8">
                            {{ order.merchant_ready_date|date:"F d, Y g:i A" }}
                        </div>
                    </div>
                    {% endif %}
                    {% if order.pickup_date %}
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="package" style="width: 16px; height: 16px;"></i> Pickup Date:</strong></div>
                        <div class="col-sm-8">
                            {{ order.pickup_date|date:"F d, Y g:i A" }}
                        </div>
                    </div>
                    {% endif %}
                    {% if order.delivered_date %}
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="truck" style="width: 16px; height: 16px;"></i> Delivered Date:</strong></div>
                        <div class="col-sm-8">
                            {{ order.delivered_date|date:"F d, Y g:i A" }}
                        </div>
                    </div>
                    {% endif %}
                    {% if order.reject_reason %}
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong><i class="align-middle" data-feather="x-circle" style="width: 16px; height: 16px;"></i> Reject Reason:</strong></div>
                        <div class="col-sm-8">
                            <div class="alert alert-danger mb-0">{{ order.reject_reason|linebreaks }}</div>
                        </div>
                    </div>
                    {% endif %}
                    <hr>
                    <form method="post" action="{% url 'myadmin:ecommerce:order_update_status' order.pk %}" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group">
                            <select class="form-select" name="status">
                                {% for value, label in order.STATUS_CHOICES %}
                                    <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">
                                <i class="align-middle" data-feather="save"></i> Update Status
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Addresses -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-feather="map-pin"></i> Addresses
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <i class="align-middle" data-feather="truck" style="width: 16px; height: 16px;"></i> Shipping Address:
                        </h6>
                        {% if order.shipping_address %}
                        <div class="p-3 border rounded bg-light">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong>{{ order.shipping_address.title }}</strong>
                                    {% if order.shipping_address.is_default %}
                                    <span class="badge bg-primary ms-2">Default</span>
                                    {% endif %}
                                </div>
                                <a href="{% url 'myadmin:core:address_detail' order.shipping_address.pk %}" class="btn btn-sm btn-outline-primary" title="View Address">
                                    <i class="align-middle" data-feather="eye" style="width: 14px; height: 14px;"></i>
                                </a>
                            </div>
                            <div class="text-muted small">
                                <div><strong>{{ order.shipping_address.full_name }}</strong></div>
                                <div class="mt-1">{{ order.shipping_address.address }}</div>
                                <div class="mt-1">{{ order.shipping_address.city }}, {{ order.shipping_address.state }} {{ order.shipping_address.zip_code }}</div>
                                <div class="mt-1">
                                    <i class="align-middle" data-feather="phone" style="width: 12px; height: 12px;"></i>
                                    {{ order.shipping_address.phone }}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-3 border rounded bg-warning bg-opacity-10 text-muted">
                            <i class="align-middle" data-feather="alert-circle" style="width: 16px; height: 16px;"></i>
                            No shipping address set
                        </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <i class="align-middle" data-feather="credit-card" style="width: 16px; height: 16px;"></i> Billing Address:
                        </h6>
                        {% if order.billing_address %}
                        <div class="p-3 border rounded bg-light">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong>{{ order.billing_address.title }}</strong>
                                    {% if order.billing_address.is_default %}
                                    <span class="badge bg-primary ms-2">Default</span>
                                    {% endif %}
                                </div>
                                <a href="{% url 'myadmin:core:address_detail' order.billing_address.pk %}" class="btn btn-sm btn-outline-primary" title="View Address">
                                    <i class="align-middle" data-feather="eye" style="width: 14px; height: 14px;"></i>
                                </a>
                            </div>
                            <div class="text-muted small">
                                <div><strong>{{ order.billing_address.full_name }}</strong></div>
                                <div class="mt-1">{{ order.billing_address.address }}</div>
                                <div class="mt-1">{{ order.billing_address.city }}, {{ order.billing_address.state }} {{ order.billing_address.zip_code }}</div>
                                <div class="mt-1">
                                    <i class="align-middle" data-feather="phone" style="width: 12px; height: 12px;"></i>
                                    {{ order.billing_address.phone }}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-3 border rounded bg-warning bg-opacity-10 text-muted">
                            <i class="align-middle" data-feather="alert-circle" style="width: 16px; height: 16px;"></i>
                            No billing address set
                        </div>
                        {% endif %}
                    </div>
                    {% if order.notes %}
                    <div class="mb-3">
                        <h6><i class="align-middle" data-feather="file-text" style="width: 16px; height: 16px;"></i> Notes:</h6>
                        <div class="p-3 bg-light rounded">
                            {{ order.notes|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Order Items -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="align-middle" data-feather="list"></i> Order Items ({{ order.items.count }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Product</th>
                                    <th>Store</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <a href="{% url 'myadmin:ecommerce:product_detail' item.product.pk %}" class="text-decoration-none">
                                            {{ item.product.name }}
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{% url 'myadmin:ecommerce:store_detail' item.store.pk %}" class="text-decoration-none">
                                            {{ item.store.name }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ item.quantity }}</span>
                                    </td>
                                    <td>₹{{ item.price|floatformat:2 }}</td>
                                    <td>
                                        <strong>₹{{ item.total|floatformat:2 }}</strong>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No items found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-end"><strong>Subtotal:</strong></td>
                                    <td><strong>₹{{ order.subtotal|floatformat:2 }}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="text-end"><strong>Shipping:</strong></td>
                                    <td><strong>₹{{ order.shipping_cost|floatformat:2 }}</strong></td>
                                </tr>
                                <tr class="table-primary">
                                    <td colspan="5" class="text-end"><strong>Grand Total:</strong></td>
                                    <td><strong>₹{{ order.total_amount|floatformat:2 }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
</script>
{% endblock %}
